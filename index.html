<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>تصميم نعي</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --dark-bg: #1a1a1a;
            --panel-bg: #2d2d2d;
            --btn-green: #27ae60;
            --btn-gold: #b8860b;
            --btn-blue: #2980b9;
        }

        body {
            font-family: 'Cairo', sans-serif; background-color: var(--dark-bg);
            margin: 0; display: flex; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; color: white;
        }

        .phone-frame {
            width: 100%; height: 100%; max-width: 450px; max-height: 900px;
            background: #000; display: flex; flex-direction: column;
            position: relative; border: 8px solid #333; border-radius: 40px; overflow: hidden;
        }

        .app-body {
            flex: 1; overflow: auto; display: flex; justify-content: center;
            align-items: flex-start; padding-top: 20px; background: #111;
        }

        #canvas-wrapper { position: relative; }

        #design-container {
            position: relative; width: 1083px; height: 1500px;
            background-color: #000; transform-origin: top center; overflow: hidden;
        }

        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        #base-image { z-index: 1; background-size: cover; background-position: center; }
        
        #photo-crop-area { 
            position: absolute; top: 444px; left: 375px; 
            width: 343px; height: 486px; 
            z-index: 5; display: none; background-size: cover; background-position: center;
        }

        #overlay-design { 
            z-index: 10; 
            pointer-events: none; 
        }

        #name-background {
            display: none; position: absolute; z-index: 18;
            background: linear-gradient(to bottom, #4a4a4a, #2c2c2c);
            border: 2px solid #555; border-radius: 15px;
        }

        .text-layer {
            position: absolute; width: 750px; left: 50%; transform: translateX(-50%);
            text-align: center; color: white; z-index: 20;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center;
            /* التعديل هنا لضمان بقاء النص في سطر واحد */
            white-space: nowrap; 
            overflow: hidden;
        }

        #text-layer-1 { top: 1200px; height: 100px; font-size: 55px; font-weight: 700; outline: none; }
        #text-layer-2 { top: 1280px; height: 60px; font-size: 40px; cursor: pointer; }
        #text-layer-3 { top: 1340px; height: 50px; font-size: 25px; font-weight: 400; }

        #controls {
            background: var(--panel-bg); padding: 10px;
            display: flex; flex-direction: column; gap: 8px; border-top: 2px solid #444;
        }
        .btn-row { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; }
        .btn {
            background: #444; color: white; border: none; padding: 8px;
            border-radius: 6px; cursor: pointer; font-family: 'Cairo'; font-size: 11px;
            flex: 1; min-width: 70px; text-align: center;
        }
        .btn-green { background: var(--btn-green); }
        .btn-gold { background: var(--btn-gold); }
        .btn-blue { background: var(--btn-blue); }
        .btn-move { background: #555; width: 35px; height: 35px; flex: none; font-weight: bold; }

        #image-edit-panel {
            background: rgba(0,0,0,0.3); padding: 5px; border-radius: 10px;
            display: none; justify-content: center; gap: 4px;
        }
    </style>
</head>
<body>

    <div class="phone-frame">
        <div class="app-body">
            <div id="canvas-wrapper">
                <div id="design-container">
                    <div id="base-image" class="layer"></div>
                    <div id="photo-crop-area"></div>
                    <div id="name-background"></div>
                    <img id="overlay-design" class="layer" src="https://i.ibb.co/MkHjQ6yN/sketch1760195853528.png">
                    
                    <div id="text-layer-1" class="text-layer" contenteditable="true" spellcheck="false">اسم الفقيد</div>
                    <div id="text-layer-2" class="text-layer">اختر التاريخ</div>
                    <div id="text-layer-3" class="text-layer"></div>
                </div>
            </div>
        </div>

        <div id="controls">
            <div class="btn-row">
                <button class="btn" onclick="setMode('man')">رجل</button>
                <button class="btn" onclick="setMode('woman')">امرأة</button>
                <button class="btn" onclick="setMode('quran')">قرآن</button>
                <button class="btn btn-gold" onclick="setMode('frame')">إطار ذهبي</button>
            </div>

            <div class="btn-row">
                <label class="btn btn-blue">خلفية مخصصة + إطار <input type="file" hidden onchange="uploadCustomBg(event)"></label>
                <label class="btn" id="person-btn" style="display:none;">صورة الشخص <input type="file" hidden onchange="uploadPerson(event)"></label>
                <button class="btn" onclick="toggleDisplay('text-layer-2')">ميلادي</button>
                <button class="btn" onclick="toggleDisplay('text-layer-3')">هجري</button>
            </div>

            <div id="image-edit-panel">
                <button class="btn btn-move" onclick="moveImg(0, -5)">↑</button>
                <button class="btn btn-move" onclick="moveImg(0, 5)">↓</button>
                <button class="btn btn-move" onclick="moveImg(-5, 0)">→</button>
                <button class="btn btn-move" onclick="moveImg(5, 0)">←</button>
                <button class="btn btn-move" onclick="zoomImg(5)">+</button>
                <button class="btn btn-move" onclick="zoomImg(-5)">-</button>
            </div>

            <button class="btn btn-green" style="font-size:14px; font-weight:bold; height: 45px;" onclick="downloadImage()">تحميل التصميم النهائي</button>
        </div>
        <input type="text" id="datepicker-proxy" style="position:fixed; opacity:0; pointer-events:none;">
    </div>

    <script>
        const container = document.getElementById('design-container');
        const nameLayer = document.getElementById('text-layer-1');
        const dateLayer = document.getElementById('text-layer-2');
        const hijriLayer = document.getElementById('text-layer-3');
        const nameBg = document.getElementById('name-background');
        const baseImg = document.getElementById('base-image');
        const overlay = document.getElementById('overlay-design');
        const photoArea = document.getElementById('photo-crop-area');
        const editPanel = document.getElementById('image-edit-panel');
        const personBtn = document.getElementById('person-btn');

        let photoState = { x: 50, y: 50, scale: 100 };

        // وظيفة ضبط الحجم ليبقى في سطر واحد
        function adjustName() {
            const MAX = 55, MIN = 15;
            let size = MAX;
            nameLayer.style.fontSize = size + 'px';
            
            // تقليل الحجم إذا تجاوز النص عرض الحاوية (750px)
            while (nameLayer.scrollWidth > nameLayer.offsetWidth && size > MIN) {
                size--;
                nameLayer.style.fontSize = size + 'px';
            }

            if (nameBg.style.display === 'block') {
                setTimeout(() => {
                    const w = nameLayer.scrollWidth;
                    const h = nameLayer.scrollHeight;
                    nameBg.style.width = (Math.min(w, 750) + 60) + 'px';
                    nameBg.style.height = (h + 20) + 'px';
                    nameBg.style.top = (parseInt(nameLayer.style.top) + (100 - (h + 20)) / 2) + 'px';
                    nameBg.style.left = '50%';
                    nameBg.style.transform = 'translateX(-50%)';
                }, 50);
            }
        }

        // منع النزول لسطر جديد عند ضغط Enter
        nameLayer.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') e.preventDefault();
        });

        nameLayer.addEventListener('input', adjustName);

        function setMode(mode) {
            container.style.width = '1083px';
            container.style.height = '1500px';
            nameBg.style.display = 'none';
            overlay.style.opacity = '1';
            overlay.src = 'https://i.ibb.co/MkHjQ6yN/sketch1760195853528.png';
            photoArea.style.display = 'none';
            editPanel.style.display = 'none';
            personBtn.style.display = 'none';

            if (mode === 'man' || mode === 'woman') {
                const url = (mode === 'man') ? 'https://i.ibb.co/C5QgVZKN/man2.jpg' : 'https://i.ibb.co/dJXKvzJj/woman2.jpg';
                baseImg.style.backgroundImage = `url('${url}')`;
                updatePos(1200, 1280, 1340);
            } 
            else if (mode === 'quran') {
                baseImg.style.backgroundImage = "url('https://i.ibb.co/QvTDBv4F/QURAN2.jpg')";
                overlay.style.opacity = '0';
                nameBg.style.display = 'block';
                updatePos(980, 1100, 1160);
            }
            else if (mode === 'frame') {
                container.style.width = '1080px';
                container.style.height = '1350px';
                overlay.src = 'https://i.ibb.co/N6Stj5Bm/375x444.png';
                baseImg.style.backgroundImage = 'none';
                photoArea.style.display = 'block';
                editPanel.style.display = 'flex';
                personBtn.style.display = 'flex';
                updatePos(1000, 1100, 1160);
            }
            adjustName();
            scaleUI();
        }

        function uploadCustomBg(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    setMode('man'); 
                    baseImg.style.backgroundImage = `url('${ev.target.result}')`;
                    overlay.style.opacity = '1'; 
                    overlay.src = 'https://i.ibb.co/MkHjQ6yN/sketch1760195853528.png';
                };
                reader.readAsDataURL(file);
            }
        }

        function uploadPerson(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    photoArea.style.backgroundImage = `url('${ev.target.result}')`;
                    photoState = { x: 50, y: 50, scale: 100 };
                    applyTrans();
                };
                reader.readAsDataURL(file);
            }
        }

        function moveImg(x, y) { photoState.x += x; photoState.y += y; applyTrans(); }
        function zoomImg(s) { photoState.scale += s; applyTrans(); }
        function applyTrans() {
            photoArea.style.backgroundPosition = `${photoState.x}% ${photoState.y}%`;
            photoArea.style.backgroundSize = `${photoState.scale}%`;
        }

        function updatePos(t1, t2, t3) {
            nameLayer.style.top = t1 + 'px';
            dateLayer.style.top = t2 + 'px';
            hijriLayer.style.top = t3 + 'px';
        }

        const fp = flatpickr("#datepicker-proxy", {
            locale: "ar",
            onChange: (dates, str) => {
                dateLayer.innerText = str.replace(/-/g, '/');
                hijriLayer.innerText = "الموافق " + new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {day:'numeric', month:'long', year:'numeric'}).format(dates[0]);
            }
        });
        dateLayer.addEventListener('click', () => fp.open());

        function toggleDisplay(id) {
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'none') ? 'flex' : 'none';
        }

        function scaleUI() {
            const wrapper = document.getElementById('canvas-wrapper');
            const body = document.querySelector('.app-body');
            const scale = (body.clientWidth - 40) / container.offsetWidth;
            container.style.transform = `scale(${scale})`;
            wrapper.style.width = (container.offsetWidth * scale) + 'px';
            wrapper.style.height = (container.offsetHeight * scale) + 'px';
        }

        window.addEventListener('resize', scaleUI);
        window.onload = () => setMode('man');

        async function downloadImage() {
            const btn = event.target;
            btn.innerText = "جاري الحفظ...";
            const originalTransform = container.style.transform;
            container.style.transform = 'none';
            window.scrollTo(0,0);
            try {
                const canvas = await html2canvas(container, {
                    useCORS: true, scale: 2,
                    width: container.offsetWidth, height: container.offsetHeight
                });
                const link = document.createElement('a');
                link.download = `Obituary_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            } catch (e) { alert("خطأ في التحميل"); }
            container.style.transform = originalTransform;
            btn.innerText = "تحميل التصميم النهائي";
            scaleUI();
        }
    </script>
</body>
</html>
